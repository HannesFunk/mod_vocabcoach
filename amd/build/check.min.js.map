{"version":3,"file":"check.min.js","sources":["../src/check.js"],"sourcesContent":["import {getBoxArrayAJAX, getFeedbackLineAJAX, getListArrayAJAX, logCheckedVocabsAJAX, updateVocabAJAX} from \"./repository\";\nimport mustache from 'core/mustache';\nimport {showElement, showElements} from \"./general\";\n\nlet vocabArrayJSON = null;\nlet knownCount = 0;\nlet unknownCount = 0;\nlet mode = '';\nlet config = {};\n\nexport const init = (configuration) => {\n    config = JSON.parse(configuration);\n    config.userid = parseInt(config.userid);\n    if (config.source === 'list') {\n        getListArrayAJAX(config.listid).then(response => {\n            vocabArrayJSON = response;\n            initDots();\n            changeMode();\n            }\n        );\n    } else if(config.source === 'user') {\n        getBoxArrayAJAX(config.userid, config.cmid, config.stage, config.force).then(response => {\n            vocabArrayJSON = response;\n            initDots();\n            changeMode();\n            }\n        );\n    }\n    addListeners();\n};\n\nfunction addListeners() {\n    document.addEventListener('click', e => {\n        if (e.target.closest(Selectors.actions.checkTypedVocab)) {\n            checkTypedVocab(config.userid);\n        } else if (e.target.closest(Selectors.actions.revealCard) && mode !== 'type') {\n            const label = e.target.closest(Selectors.actions.revealCard).getElementsByClassName('vc-check-label')[0];\n            showElements([label, 'check-third'], config.thirdActive);\n        } else if (e.target.closest(Selectors.actions.updateVocab)) {\n            checkDone(vocabArrayJSON[0].dataid, e.target.getAttribute('data-vocabcoach-known') === 'true');\n        } else if (e.target.closest(Selectors.actions.endCheck)) {\n            endCheck();\n        } else if (e.target.closest(Selectors.actions.revealTypedVocab)) {\n            document.getElementById('input-vocab-front').value = vocabArrayJSON[0].front;\n            document.getElementById('input-vocab-front').disabled = true;\n\n            showElement('button-typed-vocab-next', true);\n            showElement('check-third', config.thirdActive);\n            showElements(['button-typed-vocab-check', 'button-typed-vocab-reveal'], false);\n        } else if (e.target.closest(Selectors.actions.typedVocabUnknown)) {\n            showElements(['button-typed-vocab-next'], false);\n            showElements(['button-typed-vocab-reveal', 'button-typed-vocab-check'], true);\n\n            document.getElementById('input-vocab-front').value = '';\n            document.getElementById('input-vocab-front').disabled = false;\n\n            updateVocabAJAX(vocabArrayJSON[0].dataid, config.userid, false).then(() => {\n                updateCount(false);\n                showNext();\n            });\n        }\n    });\n\n    document.addEventListener('change', e => {\n        if (e.target.closest(Selectors.formElements.mode)) {\n            changeMode();\n        }\n    });\n\n    document.addEventListener('change', e => {\n        if (e.target.closest(Selectors.formElements.typedVocab)) {\n            document.getElementById('input-vocab-front').classList.remove('wrong');\n        }\n    });\n\n    document.addEventListener('keyup', e => {\n        if (e.target.closest(Selectors.formElements.typedVocab) &&\n            e.key === 'Enter') {\n                checkTypedVocab(config.userid);\n        }\n    });\n}\n\nconst Selectors = {\n    actions: {\n        revealCard: '[data-action=\"mod_vocabcoach/reveal-card\"]',\n        updateVocab: '[data-action=\"mod_vocabcoach/update-vocab\"]',\n        endCheck: '[data-action=\"mod_vocabcoach/end-check\"]',\n        modeChanged: '[data-action=\"mod-vocabcoach/change-mode\"]',\n        checkTypedVocab: '[data-action=\"mod-vocabcoach/typed-vocab-check\"]',\n        revealTypedVocab: '[data-action=\"mod-vocabcoach/typed-vocab-reveal\"]',\n        typedVocabUnknown: '[data-action=\"mod-vocabcoach/typed-vocab-unknown\"]',\n    },\n    formElements : {\n        mode: '[id=\"check-mode\"]',\n        typedVocab: '[id=\"input-vocab-front\"]',\n    },\n};\n\nfunction initDots() {\n    const progressBar = document.getElementById('progress-bar');\n    const totalVocab = vocabArrayJSON.length;\n    const greyDotContainer = document.createElement('div');\n    const greyDot = document.createElement('div');\n    greyDot.classList.add('vocab-dot');\n    greyDot.classList.add('unchecked');\n    greyDotContainer.appendChild(greyDot);\n\n    for (let i= 0; i<totalVocab; i++) {\n        let newDot = greyDotContainer.cloneNode(true);\n        newDot.style.transform = 'translateX(calc(100% - ' + (i+1)*12 + 'px))';\n        newDot.setAttribute('data-new-shift', (totalVocab-i)*12);\n        progressBar.appendChild(newDot);\n    }\n}\n\nexport function changeMode() {\n    mode = document.getElementById('check-mode').value;\n    vocabArrayJSON = shuffle(vocabArrayJSON);\n    const checkAreaElem = document.getElementById('check-area');\n    startAnimation(checkAreaElem, 'animation-slide-out').then(\n        () => {\n            if (mode === 'type') {\n                showElements(['check-box-front', 'check-buttons'], false);\n                showElements(['check-back', 'check-type-area'], true);\n                document.getElementById('input-vocab-front').value = '';\n                showElement(document.getElementsByClassName('instruction-front-back-random')[0], false);\n            } else {\n                showElements(['check-buttons', 'check-box-front'], true);\n                showElements(['check-type-area'], false);\n                showElement(document.getElementsByClassName('instruction-front-back-random')[0], true);\n            }\n            resetCheckFields();\n            updateLabels();\n            startAnimation(checkAreaElem, 'animation-slide-in').then(null);\n        });\n}\n\nfunction checkTypedVocab () {\n    const typed = document.getElementById('input-vocab-front').value;\n    const correct = vocabArrayJSON[0].front;\n\n    if (typed === correct && !config.force) {\n        updateVocabAJAX(vocabArrayJSON[0].dataid, config.userid, true).then(\n            () => {\n                updateCount(true);\n                showNext();\n            }\n        );\n    } else if (typed === correct) {\n        updateCount(true);\n        showNext();\n    } else {\n        document.getElementById('input-vocab-front').classList.add('wrong');\n    }\n}\n\nfunction showNext(removeShown = true) {\n    if (removeShown) {\n        vocabArrayJSON.splice(0, 1);\n    }\n\n    const numberRemaining = vocabArrayJSON.length;\n    document.getElementsByClassName('check-number-remaining')[0].innerHTML = 'Noch ' + numberRemaining +\n        ' Vokabel' + (numberRemaining === 1 ? '' : 'n');\n\n    if (numberRemaining === 0) {\n        showSummary();\n        return;\n    }\n\n    const checkAreaElem = document.getElementById('check-area');\n    startAnimation(checkAreaElem, 'animation-slide-out').then(\n        () => {\n            resetCheckFields();\n            updateLabels();\n            startAnimation(checkAreaElem, 'animation-slide-in').then(null);\n        }\n    );\n}\n\nfunction updateLabels () {\n    document.getElementById('check-front').innerHTML = vocabArrayJSON[0].front;\n    document.getElementById('check-back').innerHTML = vocabArrayJSON[0].back;\n    document.getElementById('check-third').innerHTML = vocabArrayJSON[0].third;\n    document.getElementById('check-container').setAttribute('data-vocab-data-id', vocabArrayJSON[0].dataid);\n}\n\nfunction resetCheckFields() {\n    showElement('check-third', false);\n    switch (mode) {\n        case 'random': {\n            const random = Math.floor(Math.random() * 2);\n            showElement('check-front', random === 1);\n            showElement('check-back', random === 0);\n            break;\n        }\n        case 'front':\n        case 'back':\n            showElement('check-front', mode === 'front');\n            showElement('check-back', mode === 'back');\n            break;\n\n        case 'type':\n            document.getElementById('input-vocab-front').value = '';\n            break;\n    }\n}\n\nfunction endCheck() {\n    location.href = '../../mod/vocabcoach/view.php?id=' + config.cmid;\n}\n\nfunction showSummary() {\n    let templateData = null;\n    let template = null;\n    const getMsg = getFeedbackLineAJAX(getSummaryAchievement()).then(\n        (result) => {\n            templateData = {\n                known: knownCount,\n                total: knownCount + unknownCount,\n                message: result.line,\n                thirdActive: config.thirdActive,\n            };\n        }\n    );\n\n    const getTemplate = fetch('../../mod/vocabcoach/templates/check_summary.mustache').then(\n        (res) => {\n            return res.text();\n        }\n    ).then(\n        (text) => {template = text; }\n    );\n\n    const logDetails = {\n        total: knownCount + unknownCount,\n        known: knownCount,\n        force: config.force,\n        mode: config.source\n    };\n    if (config.source === 'user') {\n        logDetails.stage = config.stage;\n    }\n    const logNumber = logCheckedVocabsAJAX(config.userid, config.cmid, JSON.stringify(logDetails));\n\n    Promise.all([getMsg, getTemplate, logNumber]).then(() => {\n        const summaryContainer = document.getElementsByClassName('check-summary')[0];\n        summaryContainer.innerHTML = mustache.render(template, templateData);\n        showElement(summaryContainer, true);\n        showElements(['check-box-front', 'check-box-back', 'check-type-area', 'check-box-third', 'check-buttons'], false);\n        const instructionElement = document.getElementsByClassName('instruction-front-back-random')[0];\n        instructionElement.innerHTML = \"Klicke in das Feld, um die Abfrage zu beenden.\";\n        showElement(instructionElement, true);\n    });\n}\n\nfunction getSummaryAchievement() {\n    const ratio = knownCount/(unknownCount + knownCount);\n\n    if (ratio > 0.9) {\n        return 5;\n    }\n    if (ratio > 0.7) {\n        return 3;\n    }\n    if (ratio > 0.5) {\n        return 2;\n    }\n    if (ratio > 0.3) {\n        return 1;\n    }\n    return 0;\n}\n\n\nfunction checkDone(vocabId, known) {\n    if (config.source === 'list' || config.force) {\n        updateCount(known);\n        showNext();\n    }\n    else {\n        updateVocabAJAX(vocabId, config.userid, known).then(\n            () => {\n                updateCount(known);\n                showNext();\n            }\n        );\n    }\n}\n\nfunction updateCount(known) {\n    if (known) {\n        knownCount++;\n    } else {\n        unknownCount++;\n    }\n\n    let bullets = document.querySelectorAll('.vocab-dot.unchecked');\n    let bullet = bullets[bullets.length - 1];\n    const newShift = bullet.parentNode.getAttribute('data-new-shift');\n    bullet.parentNode.style.transform = 'translateX(' + newShift + 'px)';\n    bullet.classList.add(known ? 'dot-green' : 'dot-red');\n    bullet.classList.remove('unchecked');\n}\n\nfunction shuffle(array) {\n    for (let i = array.length - 1; i > 0; i--) {\n        const j = Math.floor(Math.random() * (i + 1));\n        [array[i], array[j]] = [array[j], array[i]];\n    }\n    return array;\n}\n\nlet startAnimation = (el, animation) => {\n    return new Promise(resolve => {\n        const listener = () => {\n            el.removeEventListener('animationend', listener);\n            el.classList.remove(animation);\n            resolve();\n        };\n        el.addEventListener('animationend', listener);\n        el.classList.add(animation);\n    });\n};"],"names":["vocabArrayJSON","knownCount","unknownCount","mode","config","configuration","JSON","parse","userid","parseInt","source","listid","then","response","initDots","changeMode","cmid","stage","force","document","addEventListener","e","target","closest","Selectors","actions","checkTypedVocab","revealCard","label","getElementsByClassName","thirdActive","updateVocab","vocabId","dataid","known","getAttribute","updateCount","showNext","endCheck","location","href","revealTypedVocab","getElementById","value","front","disabled","typedVocabUnknown","formElements","typedVocab","classList","remove","key","modeChanged","progressBar","totalVocab","length","greyDotContainer","createElement","greyDot","add","appendChild","i","newDot","cloneNode","style","transform","setAttribute","array","j","Math","floor","random","shuffle","checkAreaElem","startAnimation","resetCheckFields","updateLabels","typed","correct","removeShown","splice","numberRemaining","innerHTML","showSummary","back","third","templateData","template","getMsg","ratio","getSummaryAchievement","result","total","message","line","getTemplate","fetch","res","text","logDetails","logNumber","stringify","Promise","all","summaryContainer","mustache","render","instructionElement","bullets","querySelectorAll","bullet","newShift","parentNode","el","animation","resolve","listener","removeEventListener"],"mappings":"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"}